# Pixel Generation System

## Overview

This document describes the automated pixel generation system that has been added to the Screeps bot. The system intelligently generates pixels when CPU usage is low and the bucket is full, maximizing pixel production without impacting bot performance.

## What Are Pixels?

According to the Screeps documentation, pixels are a valuable in-game currency that can be:
- Used to customize your game account
- Traded with other players
- Generated by spending 10,000 CPU from your bucket

## How It Works

### Core Logic

The pixel generation system is implemented in `definitions_hive_control.js` as `Control.generatePixels()` and is called at the end of every game tick in `main.js`.

**Generation Conditions (all must be met):**
1. **Enabled**: Pixel generation must be enabled in memory (default: `true`)
2. **Full Bucket**: CPU bucket must be at 10,000 (full)
3. **Low CPU Usage**: Current CPU usage must be below the configured threshold (default: 80%)

**When conditions are met:**
- Calls `Game.cpu.generatePixel()` to spend 10,000 bucket CPU for 1 pixel
- Logs generation to console with statistics
- Updates tracking statistics in memory

### Memory Structure

Pixel generation uses the following memory structure:

```javascript
Memory.hive.pixels = {
    enabled: true,              // Enable/disable pixel generation
    cpu_threshold: 0.8,         // CPU usage threshold (0.8 = 80%)
    stats: {
        total_generated: 0,     // Total pixels generated all-time
        last_generated: 0,      // Game tick when last pixel was generated
        generation_history: []  // Last 10 generation times for rate calculation
    }
}
```

## Console Commands

All pixel-related commands are available in the Screeps console and accessible via `help(pixels)`.

### View Status

```javascript
pixels.status()
```

Displays comprehensive pixel generation information:
- Current settings (enabled, CPU threshold)
- Current CPU usage and bucket level
- Total pixels generated
- Generation rate (ticks per pixel)
- Time since last pixel
- Recommendations for optimization

**Example Output:**
```
[Pixels] Pixel Generation Status:
┌──────────────────┬──────────┬────────────────────┐
│ Setting          │ Value    │ Status             │
├──────────────────┼──────────┼────────────────────┤
│ Enabled          │ true     │ ✓ Active           │
│ CPU Threshold    │ 80%      │ ✓ Below            │
│ Current CPU      │ 42.3%    │ 23.45/55           │
│ CPU Bucket       │ 10000    │ ✓ Full             │
└──────────────────┴──────────┴────────────────────┘

[Pixels] Statistics:
┌──────────────────────────┬──────────────┐
│ Metric                   │ Value        │
├──────────────────────────┼──────────────┤
│ Total Pixels Generated   │ 42           │
│ Last Generated           │ Tick 1234567 │
│ Time Since Last Pixel    │ 125 ticks ago│
│ Generation Rate          │ 130 ticks/px │
└──────────────────────────┴──────────────┘

[Pixels] ✓ Status: All conditions met for pixel generation!
```

### Enable/Disable

```javascript
pixels.enable()   // Enable automatic pixel generation (default)
pixels.disable()  // Disable automatic pixel generation
```

Use `pixels.disable()` temporarily if you need maximum CPU performance for critical operations (e.g., large combat operations, emergency responses).

### Adjust CPU Threshold

```javascript
pixels.set_threshold(percent)
```

Sets the maximum CPU usage percentage at which pixels will be generated.

**Parameters:**
- `percent`: Number between 0-100 (default: 80)

**Examples:**
```javascript
pixels.set_threshold(70)   // Conservative: only generate when using <70% CPU
pixels.set_threshold(80)   // Default: generate when using <80% CPU
pixels.set_threshold(90)   // Aggressive: generate when using <90% CPU
```

**Guidelines:**
- **70% or lower**: Use if you frequently hit CPU limits or want maximum safety margin
- **80% (default)**: Balanced approach, good for most situations
- **90% or higher**: Use if your CPU usage is consistently low and you want maximum pixel production

### Reset Statistics

```javascript
pixels.reset_stats()
```

Resets pixel generation statistics (total count, history, etc.) without affecting settings. Useful for benchmarking or after making configuration changes.

## Integration Points

### Files Modified

1. **`main.js`** (lines 101-102)
   - Added `Control.generatePixels()` call at the end of the main game loop
   - Runs after all other systems but before CPU profiling finishes

2. **`definitions_hive_control.js`** (lines 498-546)
   - Added `generatePixels()` function to the `Control` object
   - Contains all pixel generation logic and statistics tracking

3. **`definitions_console_commands.js`** (lines 1994-2110, 2127)
   - Added `pixels` command object with all management functions
   - Added to help system (accessible via `help(pixels)`)

### Load Order

The pixel generation system loads as part of the normal module load order:
1. `definitions_hive_control.js` defines the `Control.generatePixels()` function
2. `definitions_console_commands.js` defines the console command interface
3. `main.js` calls `Control.generatePixels()` every tick

## Performance Considerations

### CPU Impact

The pixel generation system itself uses minimal CPU:
- **Per-tick overhead**: ~0.05 CPU (memory reads and simple comparisons)
- **When generating**: No additional cost (pixel generation is handled by the game engine)
- **Logging**: ~0.1 CPU when a pixel is generated (infrequent)

### Bucket Management

- Pixels are only generated when bucket is at 10,000 (full)
- Each pixel generation consumes 10,000 bucket CPU
- System is designed to never impact bot performance
- Compatible with existing `pause.refill_bucket()` functionality

### Memory Usage

- Minimal: ~200 bytes for settings and statistics
- History array limited to last 10 generations to prevent memory bloat
- No impact on overall memory performance

## Usage Recommendations

### Initial Setup

When first deploying this system:

1. **Check current CPU usage:**
   ```javascript
   pixels.status()  // View current CPU usage
   ```

2. **Adjust threshold if needed:**
   ```javascript
   // If your CPU usage is typically 50-60%, keep default 80%
   // If your CPU usage is typically 70-75%, consider 85%
   pixels.set_threshold(80)  // Or your preferred value
   ```

3. **Monitor for a few hours:**
   - Watch console for pixel generation messages
   - Run `pixels.status()` periodically to check generation rate
   - Verify bucket stays full

### Optimization Tips

1. **Find your optimal threshold:**
   - Start at 80% and monitor for 24 hours
   - Check generation rate with `pixels.status()`
   - If rate is low and CPU usage is consistently below threshold, increase it
   - If bucket often drops below 10,000, decrease it

2. **Seasonal adjustments:**
   - Lower threshold during combat operations or expansion
   - Raise threshold during stable periods
   - Disable completely for critical operations if needed

3. **Monitor long-term:**
   - Track generation rate over time
   - Compare before/after threshold changes
   - Watch for patterns (time of day, room upgrades, etc.)

### Troubleshooting

**Problem: No pixels being generated**

Check in order:
1. Is pixel generation enabled? → `pixels.status()`
2. Is bucket full (10,000)? → `pixels.status()`
3. Is CPU usage below threshold? → `pixels.status()`

If all conditions are met but no pixels generate:
- Check console for error messages
- Verify `Control.generatePixels()` is being called (add temporary log)
- Check Game.cpu.generatePixel() return value

**Problem: Bucket not staying full**

This indicates CPU usage is too high for pixel generation:
- Increase CPU threshold: `pixels.set_threshold(90)`
- Or disable pixels temporarily: `pixels.disable()`
- Review other bot systems for optimization opportunities
- Consider reducing visual performance: `visuals.set_performance(10)`

**Problem: Too few pixels generated**

- Check current threshold: `pixels.status()`
- Increase threshold if CPU usage is consistently low
- Verify bucket is staying full
- Check generation rate over longer period (24+ hours)

## Example Workflow

### Daily Check

```javascript
// Morning: Check pixel generation status
pixels.status()

// Review recommendations and adjust if needed
pixels.set_threshold(85)  // If consistently generating well

// Optional: Check overall system status
resources.system_status()
```

### Before Major Operation

```javascript
// Disable pixels for critical operations
pixels.disable()

// Run your operation (combat, expansion, etc.)
// ...

// Re-enable when done
pixels.enable()
```

### Monthly Review

```javascript
// Check total pixels generated
pixels.status()

// Note: total_generated and generation_rate
// Adjust threshold based on performance
// Reset stats to track next month
pixels.reset_stats()
```

## Technical Details

### Pixel Generation Algorithm

```javascript
function generatePixels() {
    // 1. Check if enabled
    if (!enabled) return;
    
    // 2. Check if bucket is full
    if (bucket < 10000) return;
    
    // 3. Check if CPU usage is below threshold
    let cpuUsagePercent = getUsed() / limit;
    if (cpuUsagePercent >= threshold) return;
    
    // 4. Generate pixel
    let result = Game.cpu.generatePixel();
    
    // 5. Track statistics
    if (result === OK) {
        stats.total_generated++;
        stats.last_generated = Game.time;
        stats.generation_history.push(Game.time);
        if (stats.generation_history.length > 10) {
            stats.generation_history.shift();
        }
    }
}
```

### Error Codes

If pixel generation fails, the error code will be logged:
- `OK (0)`: Success
- `ERR_NOT_OWNER`: Not enough bucket CPU
- Other errors: Refer to Screeps API documentation

## Future Enhancements

Potential improvements for future versions:

1. **Adaptive Threshold**: Automatically adjust threshold based on bucket health
2. **Scheduling**: Generate pixels only during specific time windows
3. **Rate Limiting**: Limit pixel generation to N per day/hour
4. **Credits Integration**: Track pixel value vs. market energy costs
5. **Grafana Integration**: Export pixel statistics to Grafana dashboard
6. **Prediction**: Estimate when next pixel will generate based on current patterns

## References

- [Screeps Documentation - CPU](https://docs.screeps.com/api/#Game.cpu)
- [Screeps Documentation - Game.cpu.generatePixel()](https://docs.screeps.com/api/#Game.cpu.generatePixel)
- Main implementation: `definitions_hive_control.js` (line 498)
- Console commands: `definitions_console_commands.js` (line 1994)
- Main loop integration: `main.js` (line 102)

## Version History

- **v1.0** (2025-10-11): Initial implementation
  - Basic pixel generation with CPU threshold
  - Console command interface
  - Statistics tracking
  - Comprehensive documentation

---

**Last Updated**: 2025-10-11  
**Author**: azc-screeps development team  
**Status**: Production Ready

